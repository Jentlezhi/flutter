### Flutter原理与实践

#### 一、 初识Flutter

Flutter的目标是使同一套代码同时运行在Android和iOS系统上，并且拥有媲美原生应用的性能，Flutter甚至提供了两套控件来适配Android和iOS（滚动效果、字体和控件图标等等）为了让App在细节处看起来更像原生应用。
 
 
#### 二、 Dart


Dart是一种强类型、跨平台的客户端开发语言。具有专门为客户端优化、高生产力、快速高效、可移植（兼容ARM/x86）、易学的OO编程风格和原生支持响应式编程（Stream & Future）等优秀特性。Dart是强类型的语言（强类型指的是程序中表达的任何对象所从属的类型都必须能在编译时刻确定。）

Flutter在筛选了20多种语言后，最终选择Dart作为开发语言主要有几个原因：

1. 健全的类型系统，同时支持静态类型检查和运行时类型检查。
2. 代码体积优化（Tree Shaking），编译时只保留运行时需要调用的代码（不允许反射这样的隐式引用），所以庞大的Widgets库不会造成发布体积过大。
3. 丰富的底层库，Dart自身提供了非常多的库。
4. 多生代无锁垃圾回收器，专门为UI框架中常见的大量Widgets对象创建和销毁优化。
5. 跨平台，iOS和Android共用一套代码。
6. JIT & AOT运行模式，支持开发时的快速迭代和正式发布后最大程度发挥硬件性能。


在Dart中，有一些重要的基本概念需要了解：

* 所有变量的值都是对象，也就是类的实例。甚至数字、函数和null也都是对象，都继承自Object类。
* 虽然Dart是强类型语言，但是显式变量类型声明是可选的，Dart支持类型推断。如果不想使用类型推断，可以用dynamic类型。
* Dart支持泛型，List<int>表示包含int类型的列表，List<dynamic>则表示包含任意类型的列表。
* Dart支持顶层（top-level）函数和类成员函数，也支持嵌套函数和本地函数。
* Dart支持顶层变量和类成员变量。
* Dart没有public、protected和private这些关键字，使用下划线“_”开头的变量或者函数，表示只在库内可见。参考库和可见性。

AOT、JIT

Flutter支持AOT(Ahead of time)和JIT(Just in time)两种编译模式，JIT模式支持在运行过程中进行Hot Reload。刷新过程是一个增量的过程，由系统对本次和上次的代码做一次snapshot，将新的代码注入到DartVM中进行刷新。但有时会不能进行Hot Reload，此时进行一次全量的Hot Reload即可。

而AOT模式则是在运行前预先编译好，这样在每次运行过程中就不需要进行分析、编译，此模式的运行速度是最快的。Flutter同时采用了两种方案，在开发阶段采用JIT模式进行开发，在release阶段采用AOT模式，将代码打包为二进制进行发布。

在开发原生应用时，每次修改代码后都需要重新编译，并且运行到硬件设备上。由于Flutter支持Hot Reload，可以进行热重载，对项目的开发效率有很大的提升。

由于Flutter实现机制支持JIT的原因，理论上来说是支持热更新以及服务器下发代码的。可以从服务器。但是由于这样会使性能变差，而且还有审核的问题，所以Flutter并没有采用这种方案。

跨平台方案对比
现在市面上RN、Weex的技术方案基本一样，所以这里就以RN来代表类似的跨平台方案。Flutter是基于GPU进行渲染的，而RN则将渲染交给原生平台，而自己只是负责通过JSCore将视图组织起来，并处理业务逻辑。所以在渲染效果和性能这块，Flutter的性能比RN要强很多。

##### 跨平台方案对比

跨平台方案一般都需要对各个平台进行平台适配，也就是创建各自平台的适配层，RN的平台适配层要比Flutter要大很多。因为从技术实现来说，RN是通过JSCore引擎进行原生代码调用的，和原生代码交互很多，所以需要更多的适配。而Flutter则只需要对各自平台独有的特性进行适配即可，例如调用系统相册、粘贴板等。

Flutter技术实现是基于更底层实现的，对平台依赖度不是很高，相对来说，RN对平台的依赖度是很高的。所以RN未来的技术升级，包括扩展之类的，都会受到很大的限制。而Flutter未来的潜力将会很大，可以做很多技术改进。


DartVM的内存分配策略非常简单，创建对象时只需要在现有堆上移动指针，内存增长始终是线形的，省去了查找可用内存段的过程：








